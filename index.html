<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Your Invoice</title>
    <!-- 1. Uploadcare Widget Script -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="hidden"] { width: 90%; max-width: 400px; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        button:hover { background-color: #0056b3; }
        #statusMessage { margin-top: 20px; padding: 10px; border-radius: 4px; background-color: #e9ecef; }
        #resultsTable { margin-top: 20px; border-collapse: collapse; width: 100%; max-width: 600px; }
        #resultsTable th, #resultsTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #resultsTable th { background-color: #f2f2f2; }
        .hidden { display: none; } /* Class to hide elements */
    </style>
</head>
<body>

    <h1>Upload Your Invoice</h1>

    <p>Please upload your electricity invoice (image or PDF).</p>

    <!-- 2. Uploadcare Widget Input -->
    <label for="fileUploader">Invoice File:</label>
    <input
      type="hidden"
      role="uploadcare-uploader"
      data-public-key="09afefa1e6cd77c85643" <!-- !!! REPLACE THIS VALUE !!! -->
      data-images-only="false" <!-- Allow images and other files like PDF -->
      data-input-accept-types=".pdf, image/*"
      id="fileUploader"
    />

    <hr style="margin: 30px 0;">

    <h2>Check Invoice Status</h2>
    <label for="invoiceIdInput">Enter Invoice ID:</label>
    <input type="text" id="invoiceIdInput" placeholder="Enter ID received after upload">
    <button id="checkStatusBtn">Check Status</button>

    <!-- 3. Status and Result Display Area -->
    <div id="statusMessage" class="hidden"></div>
    <div id="resultsArea" class="hidden">
        <h3>Invoice Summary</h3>
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <!-- Results will be inserted here by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        // --- Uploadcare Widget Handling ---
        const widget = uploadcare.Widget('[role=uploadcare-uploader]');
        const statusMessageDiv = document.getElementById('statusMessage');
        const resultsAreaDiv = document.getElementById('resultsArea');
        const resultsTableBody = document.querySelector('#resultsTable tbody');
        const invoiceIdInput = document.getElementById('invoiceIdInput');
        const checkStatusBtn = document.getElementById('checkStatusBtn');

        widget.onUploadComplete(fileInfo => {
            // 4. File uploaded successfully via Uploadcare
            console.log("Uploadcare success:", fileInfo);
            statusMessageDiv.textContent = 'Upload successful via widget! Sending to backend...';
            statusMessageDiv.className = ''; // Make visible

            // 5. Send file info to our backend
            fetch('/api/submit-invoice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // Send relevant info, UUID is usually good, or CDN URL
                body: JSON.stringify({ fileInfo: {
                    uuid: fileInfo.uuid,
                    cdnUrl: fileInfo.cdnUrl,
                    name: fileInfo.name,
                    size: fileInfo.size
                } }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Backend response:', data);
                if (data.success && data.invoiceId) {
                    // 6. Display success message with Invoice ID
                    statusMessageDiv.textContent = `Backend processing started! Your Invoice ID is: ${data.invoiceId}. You can use this ID to check the status later.`;
                    statusMessageDiv.style.backgroundColor = '#d4edda'; // Greenish background for success
                     invoiceIdInput.value = data.invoiceId; // Pre-fill check status input
                } else {
                    statusMessageDiv.textContent = 'Error sending data to backend. Please try again. ' + (data.message || '');
                    statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error
                }
            })
            .catch(error => {
                console.error('Error sending to backend:', error);
                statusMessageDiv.textContent = 'Network error sending data to backend. Please check your connection and try again.';
                statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error
            });
        });

        widget.onChange(file => {
             if (file) {
                // When a file is selected (before upload complete)
                statusMessageDiv.textContent = 'Uploading...';
                statusMessageDiv.className = ''; // Make visible
                statusMessageDiv.style.backgroundColor = '#e9ecef'; // Neutral background
                resultsAreaDiv.className = 'hidden'; // Hide previous results
             } else {
                // When file selection is cleared
                 statusMessageDiv.className = 'hidden'; // Hide status
             }
        });

        // --- Check Status Handling ---
        checkStatusBtn.addEventListener('click', () => {
            const invoiceId = invoiceIdInput.value.trim();
            if (!invoiceId) {
                alert('Please enter an Invoice ID.');
                return;
            }

            statusMessageDiv.textContent = `Checking status for ID: ${invoiceId}...`;
            statusMessageDiv.className = ''; // Make visible
            statusMessageDiv.style.backgroundColor = '#e9ecef'; // Neutral background
            resultsAreaDiv.className = 'hidden'; // Hide previous results

            // 8. Make GET request to backend
            fetch(`/api/get-summary?invoiceId=${invoiceId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
             })
            .then(data => {
                console.log('Status check response:', data);
                statusMessageDiv.textContent = `Status for ${invoiceId}: ${data.status}`;

                if (data.status === 'Processed') {
                    // 9. Display results
                    resultsAreaDiv.className = ''; // Make results visible
                    resultsTableBody.innerHTML = ''; // Clear previous results rows

                    // Map the backend data to user-friendly labels
                    const displayData = {
                        'Facility Address': data.simplified_address, // keys are lowercase now
                        'Electricity Retailer': data.simplified_retailer,
                        'Grid Operator': data.simplified_gridop,
                        'Period': data.simplified_period,
                        'Total Cost (SEK)': data.simplified_totalcost?.toFixed(2), // Format numbers
                        'Used Electricity (kWh)': data.simplified_usedkwh?.toFixed(2),
                        'Sold Electricity (kWh)': data.simplified_soldkwh?.toFixed(2),
                        'Average Price (SEK/kWh)': data.simplified_avgprice?.toFixed(3),
                        'Fixed Cost (SEK/month)': data.simplified_fixedcost?.toFixed(2)
                    };

                    for (const [label, value] of Object.entries(displayData)) {
                        const row = resultsTableBody.insertRow();
                        const cell1 = row.insertCell();
                        const cell2 = row.insertCell();
                        cell1.textContent = label;
                        cell2.textContent = value !== undefined && value !== null ? value : 'N/A'; // Handle missing data
                    }
                     statusMessageDiv.style.backgroundColor = '#d4edda'; // Greenish background for success

                } else if (data.status === 'Error') {
                     statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error
                } else {
                    // Status is Pending, Processing, or Not Found
                     statusMessageDiv.style.backgroundColor = '#fff3cd'; // Yellowish background for pending
                }

            })
            .catch(error => {
                console.error('Error checking status:', error);
                statusMessageDiv.textContent = `Error checking status for ID ${invoiceId}. Please try again. (${error.message})`;
                statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error
            });
        });

    </script>

</body>
</html>
