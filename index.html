<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Din Verkliga Elkostnad per kWh</title>
    <style>
        /* Samma CSS som förut */
         :root { /* ... (alla dina färgvariabler) ... */
             --pencil-grey: #2B2B2B; --air-force-blue: #2F4A66; --surfie-green: #017E7A; --energetic-teal: #00FF84; --light-text: #EFEFEF; --link-color: #00FF84; --border-color: #555; --table-header-bg: #404040; --success-bg: #2a5c3d; --error-bg: #6c2a2a; --pending-bg: #6c5e2a; --neutral-bg: #444;
         }
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: var(--pencil-grey); color: var(--light-text); }
        h1, h2, h3, p, label { color: var(--light-text); }
        a { color: var(--link-color); }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 90%; max-width: 400px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--neutral-bg); color: var(--light-text); font-size: 1em; }
        button { padding: 10px 20px; background-color: var(--energetic-teal); color: var(--pencil-grey); border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-top: 5px; font-weight: bold; font-size: 1em; transition: background-color 0.2s ease; }
        button:hover { background-color: var(--surfie-green); color: var(--light-text); }
        /* Dölj Cancel/Remove - fungerar inte alltid med CSS, men värt ett försök */
        /* .uploadcare--widget__button_type_cancel, .uploadcare--widget__button_type_remove { display: none !important; } */
        .uploadcare--widget__button { background-color: var(--energetic-teal) !important; color: var(--pencil-grey) !important; border-radius: 4px !important; padding: 10px 20px !important; font-weight: bold !important; font-size: 1em !important; display: inline-block !important; margin-bottom: 15px; }
        .uploadcare--widget__button:hover { background-color: var(--surfie-green) !important; color: var(--light-text) !important; }
        .widget-container { min-height: 50px; }
        #statusMessage, #secondUploadStatus, #checkStatusMessage { margin-top: 15px; padding: 10px 15px; border-radius: 4px; background-color: var(--neutral-bg); color: var(--light-text); border: 1px solid var(--border-color); }
        .status-success { background-color: var(--success-bg); border-color: var(--energetic-teal); }
        .status-error { background-color: var(--error-bg); border-color: #ff6b6b; }
        .status-pending { background-color: var(--pending-bg); border-color: #ffed8a; }
        .status-neutral { background-color: var(--neutral-bg); border-color: var(--border-color); }
        #resultsTable { margin-top: 20px; border-collapse: collapse; width: 100%; max-width: 700px; border: 1px solid var(--border-color); }
        #resultsTable th, #resultsTable td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; color: var(--light-text); }
        #resultsTable th { background-color: var(--table-header-bg); font-weight: bold; }
        .hidden { display: none; }
        .upload-section { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: rgba(255, 255, 255, 0.03); }
        hr { margin: 40px 0; border-color: var(--border-color); }
        #keyMetricArea { text-align: center; margin-bottom: 30px; padding: 20px; background-color: var(--neutral-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        #keyMetricArea h3 { margin-top: 0; margin-bottom: 5px; font-size: 1.1em; color: var(--light-text); font-weight: normal; }
        #avgPriceValue { color: var(--energetic-teal); font-size: 2.8em; font-weight: bold; display: block; margin: 5px 0; }
        #avgPriceUnit { font-size: 1em; color: #aaa; }
        #logo { max-width: 200px; height: auto; display: block; margin: 0 auto 30px auto; }
    </style>
    <!-- Uploadcare script flyttas till slutet av body -->
</head>
<body>
    <img id="logo" src="./logo.png" alt="Sourceful Energy Logo">

    <h1>Vad Kostar Din El per kWh - Egentligen?</h1>
    <p>El- och nätfakturor är komplexa. Ladda upp dina fakturor (både elnät och elhandel om du har separata) så räknar vi ut din <strong>verkliga totalkostnad per kWh</strong>, inklusive alla fasta och rörliga avgifter.</p>

    <!-- Sektion 1: Första uppladdningen -->
    <div class="upload-section" id="firstUploadArea">
        <h2>Steg 1: Ladda upp första fakturan (Elnät eller Elhandel)</h2>
        <label>Faktura fil 1:</label>
        <div class="widget-container" id="widgetContainer1">
             <!-- Första widgetens KNAPP kommer här via JS -->
        </div>
        <div id="statusMessage" class="hidden"></div>
    </div>

    <!-- Sektion 2: Andra uppladdningen (Dold initialt) -->
    <div class="upload-section hidden" id="secondUploadArea">
        <h2>Steg 2: Ladda upp andra fakturan (om du har separat)</h2>
        <label>Faktura fil 2:</label>
        <div class="widget-container" id="widgetContainer2">
             <!-- Andra widgetens KNAPP kommer här via JS -->
        </div>
         <div id="secondUploadStatus" class="hidden"></div>
    </div>

    <hr>

    <!-- Sektion 3: Hämta Analys -->
    <div id="checkStatusSection">
      <h2>Hämta Din Analys</h2>
      <label for="invoiceIdInput">Ange Faktura-ID (från Steg 1):</label>
      <input type="text" id="invoiceIdInput" placeholder="Ange ID mottaget efter första uppladdningen">
      <button id="checkStatusBtn">Hämta Analys</button>
       <div id="checkStatusMessage" class="hidden"></div>
       <div id="keyMetricArea" class="hidden">
            <h3>Din Totalkostnad per kWh</h3>
            <span id="avgPriceValue">--</span>
            <span id="avgPriceUnit">SEK/kWh</span>
       </div>
       <div id="resultsArea" class="hidden">
           <h3>Kostnadsfördelning</h3>
           <table id="resultsTable">
               <thead><tr><th>Post</th><th>Värde</th></tr></thead>
               <tbody><!-- Results here --></tbody>
           </table>
       </div>
    </div>

    <!-- Scripts at the end -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>
    <script>
        // --- Global Variable ---
        let currentInvoiceId = null;

        // --- DOM Elements ---
        const firstUploadArea = document.getElementById('firstUploadArea');
        const secondUploadArea = document.getElementById('secondUploadArea');
        const statusMessageDiv = document.getElementById('statusMessage');
        const secondUploadStatusDiv = document.getElementById('secondUploadStatus');
        const widgetContainer1 = document.getElementById('widgetContainer1');
        const widgetContainer2 = document.getElementById('widgetContainer2');

        const resultsAreaDiv = document.getElementById('resultsArea');
        const keyMetricAreaDiv = document.getElementById('keyMetricArea');
        const avgPriceValueSpan = document.getElementById('avgPriceValue');
        const resultsTableBody = document.querySelector('#resultsTable tbody');
        const invoiceIdInput = document.getElementById('invoiceIdInput');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const checkStatusMessageDiv = document.getElementById('checkStatusMessage');

        // --- Helper to set status message style ---
        function setStatusStyle(element, type, message) {
            element.textContent = message; element.className = ''; element.classList.remove('status-success', 'status-error', 'status-pending', 'status-neutral', 'hidden'); if (type === 'success') element.classList.add('status-success'); else if (type === 'error') element.classList.add('status-error'); else if (type === 'pending') element.classList.add('status-pending'); else element.classList.add('status-neutral');
        }

        // --- Initialize Widgets ---
        let widgetElement = null;
        let secondWidgetElement = null;

        try {
             console.log("Attempting to create widget 1...");
             const widgetInput1 = document.createElement('input');
             widgetInput1.setAttribute('type', 'hidden');
             widgetInput1.setAttribute('role', 'uploadcare-uploader');
             // *** API KEY EMBEDDED ***
             widgetInput1.setAttribute('data-public-key', '09afefa1e6cd77c85643');
             widgetInput1.setAttribute('data-images-only', 'false');
             widgetInput1.setAttribute('data-clearable', 'true'); // Försök dölja Cancel/Remove
             widgetInput1.setAttribute('data-input-accept-types', '.pdf, image/*');
             widgetContainer1.appendChild(widgetInput1);
             widgetElement = uploadcare.Widget(widgetInput1);
             console.log("First widget initialized.");

             // Skapa andra widgetens input direkt men initiera inte widgeten än
             const widgetInput2 = document.createElement('input');
             widgetInput2.setAttribute('type', 'hidden');
             widgetInput2.setAttribute('role', 'uploadcare-uploader');
             // *** API KEY EMBEDDED ***
             widgetInput2.setAttribute('data-public-key', '09afefa1e6cd77c85643');
             widgetInput2.setAttribute('data-images-only', 'false');
             widgetInput2.setAttribute('data-clearable', 'true'); // Försök dölja Cancel/Remove
             widgetInput2.setAttribute('data-input-accept-types', '.pdf, image/*');
             widgetContainer2.appendChild(widgetInput2); // Lägg till input i sin container
             // Initiera INTE widgetElement2 här än

        } catch (error) { console.error("Error creating Uploadcare inputs:", error); setStatusStyle(statusMessageDiv, 'error', "Kunde inte ladda uppladdningsfunktionen."); }


        // --- Widget 1 Event Handlers ---
        if (widgetElement) {
            widgetElement.onUploadComplete(fileInfo => {
                console.log("Widget 1: Uploadcare success:", fileInfo);
                setStatusStyle(statusMessageDiv, 'neutral', 'Uppladdning lyckades! Skickar till backend...');
                secondUploadArea.classList.add('hidden'); // Håll andra dold tills vidare
                secondUploadStatusDiv.className = 'hidden';

                fetch('/api/submit-invoice', { /* ... */ method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ fileInfo: { uuid: fileInfo.uuid, cdnUrl: fileInfo.cdnUrl, name: fileInfo.name, size: fileInfo.size } }), })
                .then(response => response.json())
                .then(data => {
                    console.log('Widget 1: Backend response:', data);
                    if (data.success && data.invoiceId) {
                        currentInvoiceId = data.invoiceId;
                        setStatusStyle(statusMessageDiv, 'success', `Faktura 1 (${fileInfo.name}) uppladdad! ID: ${currentInvoiceId}. Ladda upp faktura 2 nedan om du har en separat.`);
                        // Initiera och visa andra widgeten NU
                        if (!secondWidgetElement) {
                             try {
                                 secondWidgetElement = uploadcare.Widget(widgetContainer2.querySelector('input[role=uploadcare-uploader]')); // Hitta inputen vi redan lagt till
                                 console.log("Second widget initialized on demand.");
                                 // Bifoga event handlers för andra widgeten här inne
                                  secondWidgetElement.onUploadComplete(secondFileInfo => {
                                        console.log("Widget 2: Uploadcare success:", secondFileInfo);
                                        setStatusStyle(secondUploadStatusDiv, 'neutral', 'Uppladdning av fil 2 lyckades! Länkar till första fakturan...');
                                        if (!currentInvoiceId) { console.error("Widget 2: Error - currentInvoiceId is missing."); setStatusStyle(secondUploadStatusDiv, 'error', 'Fel: Kan inte länka fil 2, ID från första uppladdningen saknas.'); return; }

                                        fetch('/api/link-second-invoice', { /* ... */ method: 'POST', headers: { 'Content-Type': 'application/json', }, body: JSON.stringify({ originalInvoiceId: currentInvoiceId, secondFileInfo: { uuid: secondFileInfo.uuid, cdnUrl: secondFileInfo.cdnUrl, name: secondFileInfo.name, size: secondFileInfo.size } }), })
                                        .then(response => response.json())
                                        .then(linkData => {
                                            console.log('Widget 2: Backend response:', linkData);
                                            if (linkData.success) { setStatusStyle(secondUploadStatusDiv, 'success', `Faktura 2 (${secondFileInfo.name}) länkad! Båda filerna mottagna för ID: ${currentInvoiceId}. Bearbetning påbörjas snart.`); }
                                            else { setStatusStyle(secondUploadStatusDiv, 'error', 'Fel vid länkning av fil 2 hos backend. ' + (linkData.message || '')); }
                                        })
                                        .catch(linkError => { console.error('Widget 2: Error sending to backend:', linkError); setStatusStyle(secondUploadStatusDiv, 'error', 'Nätverksfel vid länkning av fil 2.'); });
                                    });

                                    secondWidgetElement.onChange(file => { if (file) { setStatusStyle(secondUploadStatusDiv, 'neutral', 'Laddar upp Fil 2...'); } else { secondUploadStatusDiv.className = 'hidden'; } });

                             } catch(initError) { console.error("Error initializing widget 2:", initError); }
                        }
                        secondUploadArea.classList.remove('hidden'); // Visa andra sektionen
                        invoiceIdInput.value = currentInvoiceId;
                    } else { currentInvoiceId = null; setStatusStyle(statusMessageDiv, 'error', 'Fel vid skapande av ärende hos backend. Försök igen. ' + (data.message || '')); }
                })
                .catch(error => { currentInvoiceId = null; console.error('Widget 1: Error sending to backend:', error); setStatusStyle(statusMessageDiv, 'error', 'Nätverksfel vid kommunikation med backend.'); });
            });

            widgetElement.onChange(file => { if (file) { setStatusStyle(statusMessageDiv, 'neutral', 'Laddar upp Fil 1...'); secondUploadArea.classList.add('hidden'); resultsAreaDiv.className = 'hidden'; keyMetricAreaDiv.className = 'hidden'; checkStatusMessageDiv.className = 'hidden'; } else { statusMessageDiv.className = 'hidden'; } });
        }


        // --- Check Status Handling (Unchanged) ---
        checkStatusBtn.addEventListener('click', () => {
            const invoiceIdToCheck = invoiceIdInput.value.trim();
            if (!invoiceIdToCheck) { alert('Ange ett Faktura-ID (från uppladdningen).'); return; }
            setStatusStyle(checkStatusMessageDiv, 'neutral', `Kontrollerar status för ID: ${invoiceIdToCheck}...`);
            resultsAreaDiv.className = 'hidden'; keyMetricAreaDiv.className = 'hidden';

            fetch(`/api/get-summary?invoiceId=${invoiceIdToCheck}`)
            .then(response => { /* ... */ if (!response.ok) { if (response.status === 404) throw new Error(`Faktura-ID ${invoiceIdToCheck} hittades inte.`); throw new Error(`HTTP-fel! Status: ${response.status}`); } return response.json(); })
            .then(data => { /* ... */
                console.log('Status check response:', data); setStatusStyle(checkStatusMessageDiv, 'neutral', `Status för ${invoiceIdToCheck}: ${data.status}`);
                if (data.status === 'Processed') {
                     setStatusStyle(checkStatusMessageDiv, 'success', `Status för ${invoiceIdToCheck}: Klar!`); keyMetricAreaDiv.classList.remove('hidden'); avgPriceValueSpan.textContent = data.simplified_avgprice?.toFixed(3) ?? '--'; resultsAreaDiv.classList.remove('hidden'); resultsTableBody.innerHTML = '';
                     const displayData = { 'Anläggningsadress': data.simplified_address, 'Elhandelsbolag': data.simplified_retailer, 'Elnätsbolag': data.simplified_gridop, 'Period': data.simplified_period, 'Total Fakturerad Kostnad (SEK)': data.simplified_totalcost?.toFixed(2), 'Använd El (kWh)': data.simplified_usedkwh?.toFixed(2), 'Såld El (kWh)': data.simplified_soldkwh?.toFixed(2), 'Rörlig Kostnad (SEK/kWh)': data.simplified_variable_cost_kwh ?? 'N/A (Ej beräknad än)', 'Fast Kostnad (SEK/mån)': data.simplified_fixedcost?.toFixed(2) };
                    for (const [label, value] of Object.entries(displayData)) { if (value !== undefined || label === 'Rörlig Kostnad (SEK/kWh)') { const row = resultsTableBody.insertRow(); row.insertCell().textContent = label; row.insertCell().textContent = value !== null ? value : 'N/A'; } }
                } else if (data.status === 'Error') { setStatusStyle(checkStatusMessageDiv, 'error', `Status för ${invoiceIdToCheck}: Fel vid bearbetning.`);
                } else if (data.status === 'Not Found') { setStatusStyle(checkStatusMessageDiv, 'error', `Status för ${invoiceIdToCheck}: Hittades ej.`);
                } else { setStatusStyle(checkStatusMessageDiv, 'pending', `Status för ${invoiceIdToCheck}: ${data.status}`); }
            })
            .catch(error => { console.error('Error checking status:', error); setStatusStyle(checkStatusMessageDiv, 'error', `Fel vid statuskontroll för ID ${invoiceIdToCheck}. ${error.message}`); });
        });

        console.log("Inline script finished executing.");

    </script>

</body>
</html>
