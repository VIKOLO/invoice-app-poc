<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;title&gt;Upload Your Invoice&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- 1. Uploadcare Widget Script --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>body { font-family: sans-serif; line-height: 1.6; padding: 20px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>label { display: block; margin-bottom: 5px; font-weight: bold; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>input[type="text"], input[type="hidden"] { width: 90%; max-width: 400px; padding: 8px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>button:hover { background-color: #0056b3; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#statusMessage { margin-top: 20px; padding: 10px; border-radius: 4px; background-color: #e9ecef; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#resultsTable { margin-top: 20px; border-collapse: collapse; width: 100%; max-width: 600px; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#resultsTable th, #resultsTable td { border: 1px solid #ddd; padding: 8px; text-align: left; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>#resultsTable th { background-color: #f2f2f2; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>.hidden { display: none; } /* Class to hide elements */</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h1&gt;Upload Your Invoice&lt;/h1&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;p&gt;Please upload your electricity invoice (image or PDF).&lt;/p&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- 2. Uploadcare Widget Input --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;label for="fileUploader"&gt;Invoice File:&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;input</p>
<p class="p1"><span class="Apple-converted-space">      </span>type="hidden"</p>
<p class="p1"><span class="Apple-converted-space">      </span>role="uploadcare-uploader"</p>
<p class="p1"><span class="Apple-converted-space">      </span>data-public-key="<span class="s1">09afefa1e6cd77c85643</span>" &lt;!-- !!! REPLACE THIS VALUE !!! --&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>data-images-only="false" &lt;!-- Allow images and other files like PDF --&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>data-input-accept-types=".pdf, image/*"</p>
<p class="p1"><span class="Apple-converted-space">      </span>id="fileUploader"</p>
<p class="p1"><span class="Apple-converted-space">    </span>/&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;hr style="margin: 30px 0;"&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;h2&gt;Check Invoice Status&lt;/h2&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;label for="invoiceIdInput"&gt;Enter Invoice ID:&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;input type="text" id="invoiceIdInput" placeholder="Enter ID received after upload"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;button id="checkStatusBtn"&gt;Check Status&lt;/button&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;!-- 3. Status and Result Display Area --&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="statusMessage" class="hidden"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div id="resultsArea" class="hidden"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;h3&gt;Invoice Summary&lt;/h3&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;table id="resultsTable"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;th&gt;Item&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>&lt;th&gt;Value&lt;/th&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;/tr&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/thead&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;tbody&gt;</p>
<p class="p1"><span class="Apple-converted-space">                </span>&lt;!-- Results will be inserted here by JavaScript --&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/tbody&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/table&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Uploadcare Widget Handling ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>const widget = uploadcare.Widget('[role=uploadcare-uploader]');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const statusMessageDiv = document.getElementById('statusMessage');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const resultsAreaDiv = document.getElementById('resultsArea');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const resultsTableBody = document.querySelector('#resultsTable tbody');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const invoiceIdInput = document.getElementById('invoiceIdInput');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const checkStatusBtn = document.getElementById('checkStatusBtn');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>widget.onUploadComplete(fileInfo =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// 4. File uploaded successfully via Uploadcare</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log("Uploadcare success:", fileInfo);</p>
<p class="p1"><span class="Apple-converted-space">            </span>statusMessageDiv.textContent = 'Upload successful via widget! Sending to backend...';</p>
<p class="p1"><span class="Apple-converted-space">            </span>statusMessageDiv.className = ''; // Make visible</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 5. Send file info to our backend</p>
<p class="p1"><span class="Apple-converted-space">            </span>fetch('/api/submit-invoice', {</p>
<p class="p1"><span class="Apple-converted-space">                </span>method: 'POST',</p>
<p class="p1"><span class="Apple-converted-space">                </span>headers: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>'Content-Type': 'application/json',</p>
<p class="p1"><span class="Apple-converted-space">                </span>},</p>
<p class="p1"><span class="Apple-converted-space">                </span>// Send relevant info, UUID is usually good, or CDN URL</p>
<p class="p1"><span class="Apple-converted-space">                </span>body: JSON.stringify({ fileInfo: {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>uuid: fileInfo.uuid,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>cdnUrl: fileInfo.cdnUrl,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>name: fileInfo.name,</p>
<p class="p1"><span class="Apple-converted-space">                    </span>size: fileInfo.size</p>
<p class="p1"><span class="Apple-converted-space">                </span>} }),</p>
<p class="p1"><span class="Apple-converted-space">            </span>})</p>
<p class="p1"><span class="Apple-converted-space">            </span>.then(response =&gt; response.json())</p>
<p class="p1"><span class="Apple-converted-space">            </span>.then(data =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.log('Backend response:', data);</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (data.success &amp;&amp; data.invoiceId) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// 6. Display success message with Invoice ID</p>
<p class="p1"><span class="Apple-converted-space">                    </span>statusMessageDiv.textContent = `Backend processing started! Your Invoice ID is: ${data.invoiceId}. You can use this ID to check the status later.`;</p>
<p class="p1"><span class="Apple-converted-space">                    </span>statusMessageDiv.style.backgroundColor = '#d4edda'; // Greenish background for success</p>
<p class="p1"><span class="Apple-converted-space">                     </span>invoiceIdInput.value = data.invoiceId; // Pre-fill check status input</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>statusMessageDiv.textContent = 'Error sending data to backend. Please try again. ' + (data.message || '');</p>
<p class="p1"><span class="Apple-converted-space">                    </span>statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>})</p>
<p class="p1"><span class="Apple-converted-space">            </span>.catch(error =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error('Error sending to backend:', error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.textContent = 'Network error sending data to backend. Please check your connection and try again.';</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>widget.onChange(file =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">             </span>if (file) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// When a file is selected (before upload complete)</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.textContent = 'Uploading...';</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.className = ''; // Make visible</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.style.backgroundColor = '#e9ecef'; // Neutral background</p>
<p class="p1"><span class="Apple-converted-space">                </span>resultsAreaDiv.className = 'hidden'; // Hide previous results</p>
<p class="p1"><span class="Apple-converted-space">             </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>// When file selection is cleared</p>
<p class="p1"><span class="Apple-converted-space">                 </span>statusMessageDiv.className = 'hidden'; // Hide status</p>
<p class="p1"><span class="Apple-converted-space">             </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>// --- Check Status Handling ---</p>
<p class="p1"><span class="Apple-converted-space">        </span>checkStatusBtn.addEventListener('click', () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const invoiceId = invoiceIdInput.value.trim();</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (!invoiceId) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>alert('Please enter an Invoice ID.');</p>
<p class="p1"><span class="Apple-converted-space">                </span>return;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>statusMessageDiv.textContent = `Checking status for ID: ${invoiceId}...`;</p>
<p class="p1"><span class="Apple-converted-space">            </span>statusMessageDiv.className = ''; // Make visible</p>
<p class="p1"><span class="Apple-converted-space">            </span>statusMessageDiv.style.backgroundColor = '#e9ecef'; // Neutral background</p>
<p class="p1"><span class="Apple-converted-space">            </span>resultsAreaDiv.className = 'hidden'; // Hide previous results</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>// 8. Make GET request to backend</p>
<p class="p1"><span class="Apple-converted-space">            </span>fetch(`/api/get-summary?invoiceId=${invoiceId}`)</p>
<p class="p1"><span class="Apple-converted-space">            </span>.then(response =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!response.ok) {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>throw new Error(`HTTP error! status: ${response.status}`);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>return response.json();</p>
<p class="p1"><span class="Apple-converted-space">             </span>})</p>
<p class="p1"><span class="Apple-converted-space">            </span>.then(data =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.log('Status check response:', data);</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.textContent = `Status for ${invoiceId}: ${data.status}`;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>if (data.status === 'Processed') {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// 9. Display results</p>
<p class="p1"><span class="Apple-converted-space">                    </span>resultsAreaDiv.className = ''; // Make results visible</p>
<p class="p1"><span class="Apple-converted-space">                    </span>resultsTableBody.innerHTML = ''; // Clear previous results rows</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Map the backend data to user-friendly labels</p>
<p class="p1"><span class="Apple-converted-space">                    </span>const displayData = {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Facility Address': data.simplified_address, // keys are lowercase now</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Electricity Retailer': data.simplified_retailer,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Grid Operator': data.simplified_gridop,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Period': data.simplified_period,</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Total Cost (SEK)': data.simplified_totalcost?.toFixed(2), // Format numbers</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Used Electricity (kWh)': data.simplified_usedkwh?.toFixed(2),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Sold Electricity (kWh)': data.simplified_soldkwh?.toFixed(2),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Average Price (SEK/kWh)': data.simplified_avgprice?.toFixed(3),</p>
<p class="p1"><span class="Apple-converted-space">                        </span>'Fixed Cost (SEK/month)': data.simplified_fixedcost?.toFixed(2)</p>
<p class="p1"><span class="Apple-converted-space">                    </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                    </span>for (const [label, value] of Object.entries(displayData)) {</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const row = resultsTableBody.insertRow();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const cell1 = row.insertCell();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>const cell2 = row.insertCell();</p>
<p class="p1"><span class="Apple-converted-space">                        </span>cell1.textContent = label;</p>
<p class="p1"><span class="Apple-converted-space">                        </span>cell2.textContent = value !== undefined &amp;&amp; value !== null ? value : 'N/A'; // Handle missing data</p>
<p class="p1"><span class="Apple-converted-space">                    </span>}</p>
<p class="p1"><span class="Apple-converted-space">                     </span>statusMessageDiv.style.backgroundColor = '#d4edda'; // Greenish background for success</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">                </span>} else if (data.status === 'Error') {</p>
<p class="p1"><span class="Apple-converted-space">                     </span>statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error</p>
<p class="p1"><span class="Apple-converted-space">                </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                    </span>// Status is Pending, Processing, or Not Found</p>
<p class="p1"><span class="Apple-converted-space">                     </span>statusMessageDiv.style.backgroundColor = '#fff3cd'; // Yellowish background for pending</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">            </span>})</p>
<p class="p1"><span class="Apple-converted-space">            </span>.catch(error =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.error('Error checking status:', error);</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.textContent = `Error checking status for ID ${invoiceId}. Please try again. (${error.message})`;</p>
<p class="p1"><span class="Apple-converted-space">                </span>statusMessageDiv.style.backgroundColor = '#f8d7da'; // Reddish background for error</p>
<p class="p1"><span class="Apple-converted-space">            </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p2"><br></p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
