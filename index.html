<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fakturaöversikt</title>
    <style>
        /* Samma CSS som i förra versionen, lägger till stil för nya knappen */
        :root { /* ... (alla dina färgvariabler) ... */
             --pencil-grey: #2B2B2B; --air-force-blue: #2F4A66; --surfie-green: #017E7A; --energetic-teal: #00FF84; --light-text: #EFEFEF; --link-color: #00FF84; --border-color: #555; --table-header-bg: #404040; --success-bg: #2a5c3d; --error-bg: #6c2a2a; --pending-bg: #6c5e2a; --neutral-bg: #444;
         }
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; background-color: var(--pencil-grey); color: var(--light-text); }
        h1, h2, h3, p, label { color: var(--light-text); }
        a { color: var(--link-color); }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: 90%; max-width: 400px; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--neutral-bg); color: var(--light-text); font-size: 1em; }
        button { padding: 10px 20px; background-color: var(--energetic-teal); color: var(--pencil-grey); border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-top: 5px; font-weight: bold; font-size: 1em; transition: background-color 0.2s ease; }
        button:hover { background-color: var(--surfie-green); color: var(--light-text); }
        /* Gör sekundär knapp lite annorlunda */
        button.secondary { background-color: var(--neutral-bg); color: var(--energetic-teal); border: 1px solid var(--energetic-teal); }
        button.secondary:hover { background-color: var(--border-color); }

        .uploadcare--widget__button { background-color: var(--energetic-teal) !important; color: var(--pencil-grey) !important; border-radius: 4px !important; padding: 10px 20px !important; font-weight: bold !important; font-size: 1em !important; display: inline-block !important; margin-bottom: 15px; }
        .uploadcare--widget__button:hover { background-color: var(--surfie-green) !important; color: var(--light-text) !important; }
        .widget-container { min-height: 50px; margin-bottom: 15px; }

        #statusMessage, #secondUploadStatus, #checkStatusMessage { margin-top: 15px; padding: 10px 15px; border-radius: 4px; background-color: var(--neutral-bg); color: var(--light-text); border: 1px solid var(--border-color); }
        .status-success { background-color: var(--success-bg); border-color: var(--energetic-teal); }
        .status-error { background-color: var(--error-bg); border-color: #ff6b6b; }
        .status-pending { background-color: var(--pending-bg); border-color: #ffed8a; }
        .status-neutral { background-color: var(--neutral-bg); border-color: var(--border-color); }

        #resultsTable { margin-top: 20px; border-collapse: collapse; width: 100%; max-width: 700px; border: 1px solid var(--border-color); }
        #resultsTable th, #resultsTable td { border: 1px solid var(--border-color); padding: 10px 12px; text-align: left; color: var(--light-text); }
        #resultsTable th { background-color: var(--table-header-bg); font-weight: bold; }
        .hidden { display: none; }
        .upload-section { margin-bottom: 30px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: rgba(255, 255, 255, 0.03); }
        hr { margin: 40px 0; border-color: var(--border-color); }
        #keyMetricArea { text-align: center; margin-bottom: 30px; padding: 20px; background-color: var(--neutral-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        #keyMetricArea h3 { margin-top: 0; margin-bottom: 5px; font-size: 1.1em; color: var(--light-text); font-weight: normal; }
        #avgPriceValue { color: var(--energetic-teal); font-size: 2.8em; font-weight: bold; display: block; margin: 5px 0; }
        #avgPriceUnit { font-size: 1em; color: #aaa; }
        #logo { max-width: 200px; height: auto; display: block; margin: 0 auto 30px auto; }
    </style>
    <!-- Uploadcare script flyttas till slutet av body -->
</head>
<body>
    <img id="logo" src="./logo.png" alt="Sourceful Energy Logo">

    <h1>Din Fakturaöversikt</h1>
    <p>Ladda upp din elnäts- och/eller elhandelsfaktura för att få en enkel sammanställning. </p>
    
    <div style="background-color: var(--neutral-bg); padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--border-color);">
        <h3>Hur det fungerar:</h3>
        <ol style="margin-left: 20px;">
            <li>Ladda upp din elnätsfaktura (PDF eller bild)</li>
            <li>Om du har en separat elhandelsfaktura för samma period, ladda upp den också</li>
            <li>Få en tydlig sammanställning av dina kostnader och förbrukning</li>
        </ol>
        <p style="margin-top: 15px; font-style: italic;">Tips: För bästa resultat, ladda upp både elnäts- och elhandelsfakturor för samma period.</p>
    </div>

    <!-- Sektion 1: Uppladdning -->
    <div class="upload-section" id="uploadArea">
        <h2>Ladda upp faktura</h2>
        <label>Fakturafil:</label>
        <div class="widget-container" id="widgetContainer1">
             <!-- Första widgetens KNAPP kommer här via JS -->
        </div>
        <div id="statusMessage" class="hidden"></div>

        <!-- Knapp och område för ev. andra fakturan (dolt initialt) -->
        <button id="showSecondUploadBtn" class="secondary hidden">Ladda upp en till faktura för samma period</button>
        <div id="secondUploadWidgetArea" class="hidden" style="margin-top: 15px;">
            <label>Fakturafil 2:</label>
             <div class="widget-container" id="widgetContainer2">
                 <!-- Andra widgetens KNAPP kommer här via JS -->
             </div>
             <div id="secondUploadStatus" class="hidden"></div>
        </div>
    </div>

    <hr>

    <!-- Sektion 2: Kontrollera Status -->
    <div id="checkStatusSection">
      <h2>Kontrollera Fakturastatus</h2>
      <label for="invoiceIdInput">Ange Faktura-ID (från uppladdningen):</label>
      <input type="text" id="invoiceIdInput" placeholder="Ange ID mottaget efter uppladdningen">
      <button id="checkStatusBtn">Kontrollera Status</button>
       <div id="checkStatusMessage" class="hidden"></div>
       <div id="keyMetricArea" class="hidden">
            <h3>Din Totalkostnad per kWh</h3>
            <span id="avgPriceValue">--</span>
            <span id="avgPriceUnit">SEK/kWh</span>
       </div>
       <div id="resultsArea" class="hidden">
           <h3>Detaljerad Sammanställning</h3>
           <table id="resultsTable">
               <thead><tr><th>Post</th><th>Värde</th></tr></thead>
               <tbody><!-- Results here --></tbody>
           </table>
       </div>
    </div>

    <!-- Scripts at the end -->
    <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js" charset="utf-8"></script>
    <script>
        // --- Global Variable ---
        let currentInvoiceId = null;
        let secondWidgetElement = null; // Håll reda på andra widgeten

        // --- DOM Elements ---
        const statusMessageDiv = document.getElementById('statusMessage');
        const showSecondUploadBtn = document.getElementById('showSecondUploadBtn');
        const secondUploadWidgetArea = document.getElementById('secondUploadWidgetArea');
        const secondUploadStatusDiv = document.getElementById('secondUploadStatus');
        const widgetContainer1 = document.getElementById('widgetContainer1');
        const widgetContainer2 = document.getElementById('widgetContainer2');

        const resultsAreaDiv = document.getElementById('resultsArea');
        const keyMetricAreaDiv = document.getElementById('keyMetricArea');
        const avgPriceValueSpan = document.getElementById('avgPriceValue');
        const resultsTableBody = document.querySelector('#resultsTable tbody');
        const invoiceIdInput = document.getElementById('invoiceIdInput');
        const checkStatusBtn = document.getElementById('checkStatusBtn');
        const checkStatusMessageDiv = document.getElementById('checkStatusMessage');

        // --- Helper to set status message style ---
        function setStatusStyle(element, type, message) {
            element.textContent = message;
            element.className = ''; // Remove hidden first if needed
            element.classList.remove('status-success', 'status-error', 'status-pending', 'status-neutral', 'hidden');
            if (type === 'success') element.classList.add('status-success');
            else if (type === 'error') element.classList.add('status-error');
            else if (type === 'pending') element.classList.add('status-pending');
            else element.classList.add('status-neutral');
        }

        // --- Initialize FIRST Widget ---
        try {
             console.log("Attempting to create widget 1...");
             const widgetInput1 = document.createElement('input');
             widgetInput1.setAttribute('type', 'hidden');
             widgetInput1.setAttribute('role', 'uploadcare-uploader');
             widgetInput1.setAttribute('data-public-key', '09afefa1e6cd77c85643'); /* !!! ADD YOUR KEY HERE !!! */
             widgetInput1.setAttribute('data-images-only', 'false');
             widgetInput1.setAttribute('data-clearable', 'false'); // Försök ta bort cancel/remove
             widgetInput1.setAttribute('data-input-accept-types', '.pdf, image/*');
             widgetContainer1.appendChild(widgetInput1);
             const widgetElement = uploadcare.Widget(widgetInput1);
             console.log("First widget initialized.");

             // --- Widget 1 Event Handlers ---
             widgetElement.onUploadComplete(fileInfo => {
                console.log("Widget 1: Uploadcare success:", fileInfo);
                setStatusStyle(statusMessageDiv, 'neutral', 'Uppladdning lyckades! Skickar till backend...');
                showSecondUploadBtn.classList.add('hidden'); // Göm knappen medan vi anropar backend
                secondUploadWidgetArea.classList.add('hidden'); // Göm andra widgetens område
                secondUploadStatusDiv.className = 'hidden'; // Göm status för andra

                fetch('/api/submit-invoice', { /* ... */
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', },
                    body: JSON.stringify({ fileInfo: { uuid: fileInfo.uuid, cdnUrl: fileInfo.cdnUrl, name: fileInfo.name, size: fileInfo.size } }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Widget 1: Backend response:', data);
                    if (data.success && data.invoiceId) {
                        currentInvoiceId = data.invoiceId;
                        setStatusStyle(statusMessageDiv, 'success', `Faktura 1 (${fileInfo.name}) uppladdad! ID: ${currentInvoiceId}. Har du en separat faktura för samma period?`);
                        showSecondUploadBtn.classList.remove('hidden'); // Visa knappen för att ladda upp en till
                        invoiceIdInput.value = currentInvoiceId;
                    } else {
                        currentInvoiceId = null;
                        setStatusStyle(statusMessageDiv, 'error', 'Fel vid skapande av ärende hos backend. Försök igen. ' + (data.message || ''));
                    }
                })
                .catch(error => {
                    currentInvoiceId = null;
                    console.error('Widget 1: Error sending to backend:', error);
                    setStatusStyle(statusMessageDiv, 'error', 'Nätverksfel vid kommunikation med backend. Kontrollera anslutning och försök igen.');
                });
            });

            widgetElement.onChange(file => {
                 if (file) {
                    setStatusStyle(statusMessageDiv, 'neutral', 'Laddar upp Fil 1...');
                    showSecondUploadBtn.classList.add('hidden'); // Göm knapp under uppladdning
                    secondUploadWidgetArea.classList.add('hidden');
                    resultsAreaDiv.className = 'hidden';
                    keyMetricAreaDiv.className = 'hidden';
                    checkStatusMessageDiv.className = 'hidden';
                 } else {
                    statusMessageDiv.className = 'hidden';
                 }
            });

        } catch (error) {
             console.error("Error initializing Uploadcare widget 1:", error);
             setStatusStyle(statusMessageDiv, 'error', "Kunde inte ladda uppladdningsfunktionen. Kontrollera konsolen.");
        }

        // --- Hantera klick på "Ladda upp en till" ---
        showSecondUploadBtn.addEventListener('click', () => {
            secondUploadWidgetArea.classList.remove('hidden'); // Visa området för andra widgeten
            showSecondUploadBtn.classList.add('hidden'); // Göm knappen när området visas

            // Initiera ANDRA widgeten FÖRSTA gången den ska visas
            if (!secondWidgetElement) {
                try {
                    console.log("Initializing widget 2 for the first time...");
                    const widgetInput2 = document.createElement('input');
                    widgetInput2.setAttribute('type', 'hidden');
                    widgetInput2.setAttribute('role', 'uploadcare-uploader');
                    widgetInput2.setAttribute('data-public-key', '09afefa1e6cd77c85643'); /* !!! ADD YOUR KEY HERE !!! */
                    widgetInput2.setAttribute('data-images-only', 'false');
                    widgetInput2.setAttribute('data-clearable', 'false'); // Försök ta bort cancel/remove
                    widgetInput2.setAttribute('data-input-accept-types', '.pdf, image/*');
                    widgetContainer2.innerHTML = ''; // Rensa eventuell gammal input
                    widgetContainer2.appendChild(widgetInput2);
                    secondWidgetElement = uploadcare.Widget(widgetInput2);
                    console.log("Second widget initialized.");

                    // --- Widget 2 Event Handlers ---
                    secondWidgetElement.onUploadComplete(secondFileInfo => {
                        console.log("Widget 2: Uploadcare success:", secondFileInfo);
                        setStatusStyle(secondUploadStatusDiv, 'neutral', 'Uppladdning av fil 2 lyckades! Länkar till första fakturan...');

                        if (!currentInvoiceId) {
                             console.error("Widget 2: Error - currentInvoiceId is missing.");
                             setStatusStyle(secondUploadStatusDiv, 'error', 'Fel: Kan inte länka fil 2, ID från första uppladdningen saknas. Ladda upp fil 1 igen.');
                             return;
                        }

                        fetch('/api/link-second-invoice', { /* ... */
                           method: 'POST',
                           headers: { 'Content-Type': 'application/json', },
                           body: JSON.stringify({
                               originalInvoiceId: currentInvoiceId,
                               secondFileInfo: { uuid: secondFileInfo.uuid, cdnUrl: secondFileInfo.cdnUrl, name: secondFileInfo.name, size: secondFileInfo.size }
                           }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Widget 2: Backend response:', data);
                            if (data.success) {
                                setStatusStyle(secondUploadStatusDiv, 'success', `Faktura 2 (${secondFileInfo.name}) länkad! Båda filerna mottagna för ID: ${currentInvoiceId}. Bearbetning påbörjas snart.`);
                                // Dölj området igen nu när den är klar? Eller låt vara? Låt vara just nu.
                                // secondUploadWidgetArea.classList.add('hidden');
                            } else {
                                setStatusStyle(secondUploadStatusDiv, 'error', 'Fel vid länkning av fil 2 hos backend. Försök ladda upp fil 2 igen. ' + (data.message || ''));
                            }
                        })
                        .catch(error => {
                            console.error('Widget 2: Error sending to backend:', error);
                             setStatusStyle(secondUploadStatusDiv, 'error', 'Nätverksfel vid länkning av fil 2. Kontrollera anslutning och försök igen.');
                        });
                    });

                    secondWidgetElement.onChange(file => {
                         if (file) { setStatusStyle(secondUploadStatusDiv, 'neutral', 'Laddar upp Fil 2...'); }
                         else { secondUploadStatusDiv.className = 'hidden'; }
                    });

                } catch (error) {
                    console.error("Error initializing Uploadcare widget 2:", error);
                    setStatusStyle(secondUploadStatusDiv, 'error', "Kunde inte ladda andra uppladdningsfunktionen.");
                    secondUploadWidgetArea.classList.add('hidden'); // Göm igen om det misslyckas
                    showSecondUploadBtn.classList.remove('hidden'); // Visa knappen igen
                }
            }
        });


        // --- Check Status Handling (Unchanged) ---
        checkStatusBtn.addEventListener('click', () => {
            const invoiceIdToCheck = invoiceIdInput.value.trim();
            if (!invoiceIdToCheck) { alert('Ange ett Faktura-ID (från uppladdningen).'); return; }
            setStatusStyle(checkStatusMessageDiv, 'neutral', `Kontrollerar status för ID: ${invoiceIdToCheck}...`);
            resultsAreaDiv.className = 'hidden';
            keyMetricAreaDiv.className = 'hidden';

            fetch(`/api/get-summary?invoiceId=${invoiceIdToCheck}`)
            .then(response => { /* ... */
                if (!response.ok) { if (response.status === 404) throw new Error(`Faktura-ID ${invoiceIdToCheck} hittades inte.`); throw new Error(`HTTP-fel! Status: ${response.status}`); } return response.json(); })
            .then(data => { /* ... */
                console.log('Status check response:', data);
                setStatusStyle(checkStatusMessageDiv, 'neutral', `Status för ${invoiceIdToCheck}: ${data.status}`);
                if (data.status === 'Processed') {
                     setStatusStyle(checkStatusMessageDiv, 'success', `Status för ${invoiceIdToCheck}: ${data.status}`);
                     keyMetricAreaDiv.classList.remove('hidden');
                     avgPriceValueSpan.textContent = data.simplified_avgprice?.toFixed(3) ?? '--';
                     resultsAreaDiv.classList.remove('hidden');
                     resultsTableBody.innerHTML = '';
                     const displayData = { 'Anläggningsadress': data.simplified_address, 'Elhandelsbolag': data.simplified_retailer, 'Elnätsbolag': data.simplified_gridop, 'Period': data.simplified_period, 'Total Kostnad (SEK)': data.simplified_totalcost?.toFixed(2), 'Använd El (kWh)': data.simplified_usedkwh?.toFixed(2), 'Såld El (kWh)': data.simplified_soldkwh?.toFixed(2), 'Fast Kostnad (SEK/mån)': data.simplified_fixedcost?.toFixed(2) };
                    for (const [label, value] of Object.entries(displayData)) { if (value !== undefined) { const row = resultsTableBody.insertRow(); row.insertCell().textContent = label; row.insertCell().textContent = value !== null ? value : 'N/A'; } }
                } else if (data.status === 'Error') { setStatusStyle(checkStatusMessageDiv, 'error', `Status för ${invoiceIdToCheck}: Fel vid bearbetning.`);
                } else if (data.status === 'Not Found') { setStatusStyle(checkStatusMessageDiv, 'error', `Status för ${invoiceIdToCheck}: Hittades ej.`);
                } else { setStatusStyle(checkStatusMessageDiv, 'pending', `Status för ${invoiceIdToCheck}: ${data.status}`); } })
            .catch(error => { console.error('Error checking status:', error); setStatusStyle(checkStatusMessageDiv, 'error', `Fel vid statuskontroll för ID ${invoiceIdToCheck}. ${error.message}`); });
        });

        console.log("Inline script finished executing.");

    </script>

</body>
</html>
